<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì´ˆë¡ì† - ì±—ë´‡ ìƒë‹´</title>
    <link rel="stylesheet" href="/static/style.css"> <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        /* ê¸°ë³¸ ìŠ¤íƒ€ì¼ì€ ê¸°ì¡´ style.cssì—ì„œ ê°€ì ¸ì˜¤ê³ , ì±—ë´‡ ê´€ë ¨ ìŠ¤íƒ€ì¼ë§Œ ì—¬ê¸°ì— ì„ì‹œë¡œ ì •ì˜ */
        body { font-family: 'Noto Sans KR', sans-serif; margin: 0; background-color: #f4f7f6; display: flex; flex-direction: column; min-height: 100vh; }
        .app-container { max-width: 1200px; margin: 20px auto; background-color: #fff; border-radius: 8px; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05); overflow: hidden; display: flex; flex-direction: column; width: 100%; }
        .header { background-color: #4CAF50; color: white; padding: 15px 20px; text-align: center; font-size: 24px; font-weight: 700; }
        .nav-bar { background-color: #f2f2f2; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #ddd; }
        .nav-bar a { color: #333; text-decoration: none; padding: 8px 15px; border-radius: 5px; transition: background-color 0.3s; font-weight: 500; }
        .nav-bar a:hover { background-color: #e2e2e2; }
        .nav-bar a.active { background-color: #4CAF50; color: white; }
        .hamburger-icon { display: none; background: none; border: none; font-size: 24px; cursor: pointer; padding: 5px; }
        .nav-links-container { display: flex; gap: 10px; }
        .main-content-panel { padding: 20px; background-color: #f8f8f8; flex-grow: 1; }
        .card { background-color: white; border-radius: 8px; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05); margin-bottom: 20px; overflow: hidden; }
        .card-header { background-color: #8BC34A; color: white; padding: 15px 20px; font-size: 18px; font-weight: 700; }
        .card-content { padding: 20px; }

        /* ì±—ë´‡ ìŠ¤íƒ€ì¼ */
        #chat-history { max-height: 400px; overflow-y: auto; border: 1px solid #ddd; border-radius: 8px; padding: 15px; margin-bottom: 20px; background-color: #fcfcfc; display: flex; flex-direction: column; }
        .chat-message { display: flex; margin-bottom: 10px; align-items: flex-end; }
        .chat-message.user { justify-content: flex-end; }
        .chat-message.bot { justify-content: flex-start; }
        .message-bubble { padding: 10px 15px; border-radius: 18px; max-width: 70%; line-height: 1.4; word-wrap: break-word; }
        .chat-message.user .message-bubble { background-color: #DCF8C6; color: #333; border-bottom-right-radius: 2px; }
        .chat-message.bot .message-bubble { background-color: #E2E2E2; color: #333; border-bottom-left-radius: 2px; }
        .message-info { font-size: 12px; color: #888; margin-bottom: 4px; display: flex; align-items: center; }
        .chat-message.user .message-info { justify-content: flex-end; margin-right: 10px; }
        .chat-message.bot .message-info { justify-content: flex-start; margin-left: 10px; }
        .message-sender { font-weight: bold; margin-right: 5px; }
        .chat-input-container { display: flex; gap: 10px; margin-top: 20px; }
        #chat-input { flex-grow: 1; padding: 10px 15px; border: 1px solid #ddd; border-radius: 20px; font-size: 16px; }
        #send-chat-message { background-color: #4CAF50; color: white; border: none; padding: 10px 20px; border-radius: 20px; cursor: pointer; font-size: 16px; transition: background-color 0.3s; }
        #send-chat-message:hover { background-color: #45a049; }
        .btn { background-color: #2196F3; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; text-decoration: none; text-align: center; display: inline-block; }
        .btn:hover { background-color: #1e88e5; }

        /* ê³ ê¸‰ ê¸°ëŠ¥ (ë§í¬, íŒŒì¼ ë‹¤ìš´ë¡œë“œ) ìŠ¤íƒ€ì¼ */
        /* .message-bubble a { color: #007bff; text-decoration: underline; cursor: pointer; } */ /* ì´ì œ FastAPIì—ì„œ ì§ì ‘ ë§í¬ í´ë˜ìŠ¤ë¥¼ ì¶”ê°€í•˜ë¯€ë¡œ ì´ ë¶€ë¶„ì€ í•„ìš” ì—†ì„ ìˆ˜ ìˆìŒ */
        .link-button { /* FastAPIì—ì„œ ìƒì„±ëœ ë§í¬ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
            display: inline-block;
            padding: 5px 10px;
            margin-top: 5px;
            background-color: #007bff;
            color: white;
            border-radius: 5px;
            text-decoration: none;
            text-align: center;
        }
        .link-button:hover { background-color: #0056b3; }
        .download-link {
            display: inline-block;
            margin-top: 10px;
            padding: 8px 12px;
            background-color: #007bff;
            color: white;
            border-radius: 5px;
            text-decoration: none;
            text-align: center;
        }
        .download-link:hover { background-color: #0056b3; }

        /* ëª¨ë°”ì¼ ë°˜ì‘í˜• */
        @media (max-width: 768px) {
            .nav-links-container { flex-direction: column; width: 100%; display: none; }
            .nav-bar { flex-wrap: wrap; }
            .hamburger-icon { display: block; }
            .nav-links-container.active { display: flex; }
        }
    </style>
</head>
<body>
<div class="app-container">
    <div class="header">ğŸŒ¿ ì´ˆë¡ì† í”„ë¡œì íŠ¸ ìŠ¤í† ë¦¬ë³´ë“œ ğŸŒ¿</div>

    <div class="nav-bar">
        <button class="hamburger-icon" onclick="toggleNavMenu()">
            <i class="material-icons">menu</i>
        </button>
        <div class="nav-links-container" id="navLinksContainer">
            <a href="main.html">ë‚´ ë†ì¥</a>
            <a href="1.html">ì‘ë¬¼ ì¶”ê°€</a>
            <a href="2.html">ì‘ë¬¼ ì¶”ì²œ</a>
            <a href="3.html">ì¬ë°° ê°€ì´ë“œ</a>
            <a href="4.html">ì‘ë¬¼ ì§„ë‹¨</a>
            <a href="5.html">ë¬¸ì œ í•´ê²°</a>
            <a href="chatbot.html">ì±—ë´‡ ìƒë‹´</a>
            <a href="7.html">í™˜ê²½ ëª¨ë‹ˆí„°ë§</a>
            <a href="8.html">ìˆ˜ê²½ ëª¨ë‹ˆí„°ë§</a>
        </div>
    </div>

    <div class="main-content-panel">
        <section id="chatbot-panel">
            <div class="card">
                <div class="card-header">ğŸ’¬ AI ì±—ë´‡ ë†ì—… ìƒë‹´ ğŸ’¬</div>
                <div class="card-content">
                    <div id="chat-history">
                        <div class="chat-message bot">
                            <div class="message-info">
                                <span class="message-sender">AgroBuddy ì±—ë´‡</span> <span class="message-time">[<span class="current-time"></span>]</span>
                            </div>
                            <div class="message-bubble">ì•ˆë…•í•˜ì„¸ìš”! ë†ì—…ì— ëŒ€í•´ ê¶ê¸ˆí•œ ì ì„ ë¬¼ì–´ë³´ì„¸ìš”.</div>
                        </div>
                    </div>
                    <div class="chat-input-container">
                        <input type="text" id="chat-input" placeholder="ë©”ì‹œì§€ ì…ë ¥...">
                        <button id="send-chat-message">ì „ì†¡</button>
                    </div>
                    <button class="btn" style="width: 100%; margin-top: 20px;" onclick="window.location.href='main.html'">ë‚´ ë†ì¥ìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>
                </div>
            </div>
        </section>
    </div>
</div>
<script src="/static/script.js"></script>
<script>
    // í–„ë²„ê±° ë©”ë‰´ í† ê¸€ ê¸°ëŠ¥ (ê¸°ì¡´ ì½”ë“œ ìœ ì§€)
    function toggleNavMenu() {
        const navLinksContainer = document.getElementById('navLinksContainer');
        navLinksContainer.classList.toggle('active');
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ, nav-barì˜ 'ì±—ë´‡ ìƒë‹´' ë§í¬ë¥¼ í™œì„±í™”
    document.addEventListener('DOMContentLoaded', () => {
        const currentPath = window.location.pathname.split('/').pop();
        const navLinks = document.querySelectorAll('.nav-bar a');
        navLinks.forEach(link => {
            const linkPath = link.getAttribute('href').split('/').pop(); // hrefì—ì„œ íŒŒì¼ëª…ë§Œ ì¶”ì¶œ
            if (linkPath === currentPath) {
                link.classList.add('active');
            } else {
                link.classList.remove('active');
            }
        });

        // ì´ˆê¸° ì±—ë´‡ í™˜ì˜ ë©”ì‹œì§€ì˜ ì‹œê°„ ì„¤ì •
        document.querySelector('.current-time').textContent = getCurrentTime();

        // ì±—ë´‡ ê´€ë ¨ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë°”ì¸ë”©
        const sendButton = document.getElementById('send-chat-message');
        const chatInput = document.getElementById('chat-input');
        if (sendButton && chatInput) {
            sendButton.addEventListener('click', sendMessage);
            chatInput.addEventListener('keypress', function (e) {
                if (e.key === 'Enter') {
                    sendMessage();
                    e.preventDefault(); // Enter í‚¤ ì…ë ¥ ì‹œ ì¤„ ë°”ê¿ˆ ë°©ì§€
                }
            });
        }
    });

    // í˜„ì¬ ì‹œê°„ ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜
    function getCurrentTime() {
        const now = new Date();
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');
        return `${hours}:${minutes}`;
    }

    // ë©”ì‹œì§€ë¥¼ ì±„íŒ… ê¸°ë¡ì— ì¶”ê°€í•˜ëŠ” í•¨ìˆ˜
    function addMessageToChat(sender, messageHtmlContent, isUser = false) {
        const chatHistory = document.getElementById('chat-history');
        const messageClass = isUser ? 'user' : 'bot';
        const senderName = isUser ? 'ë‚˜' : 'AgroBuddy ì±—ë´‡';
        const messageDiv = document.createElement('div');
        messageDiv.className = `chat-message ${messageClass}`;
        messageDiv.innerHTML = `
            <div class="message-info">
                <span class="message-sender">${senderName}</span>
                <span class="message-time">[${getCurrentTime()}]</span>
            </div>
            <div class="message-bubble">${messageHtmlContent}</div>
        `;
        chatHistory.appendChild(messageDiv);
        chatHistory.scrollTop = chatHistory.scrollHeight; // ìŠ¤í¬ë¡¤ì„ ë§¨ ì•„ë˜ë¡œ
    }

    // ì±—ë´‡ APIë¡œ ë©”ì‹œì§€ë¥¼ ì „ì†¡í•˜ê³  ì‘ë‹µì„ ë°›ëŠ” í•¨ìˆ˜
    async function sendMessage() {
        const chatInput = document.getElementById('chat-input');
        const userMessage = chatInput.value.trim();

        if (userMessage === "") {
            return; // ë¹ˆ ë©”ì‹œì§€ëŠ” ì „ì†¡í•˜ì§€ ì•ŠìŒ
        }

        addMessageToChat('user', userMessage, true); // ì‚¬ìš©ì ë©”ì‹œì§€ í‘œì‹œ
        chatInput.value = ''; // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”

        // ë¡œë”© ë©”ì‹œì§€ í‘œì‹œ
        const loadingMessageDiv = document.createElement('div');
        loadingMessageDiv.className = 'chat-message bot';
        loadingMessageDiv.innerHTML = `
            <div class="message-info">
                <span class="message-sender">AgroBuddy ì±—ë´‡</span> <span class="message-time">[${getCurrentTime()}]</span>
            </div>
            <div class="message-bubble">...</div>
        `;
        document.getElementById('chat-history').appendChild(loadingMessageDiv);
        document.getElementById('chat-history').scrollTop = document.getElementById('chat-history').scrollHeight;

        try {
            // FastAPI ì±—ë´‡ API í˜¸ì¶œ
            // user_idëŠ” í˜„ì¬ í•˜ë“œì½”ë”©ëœ 1ì„ ë³´ëƒ…ë‹ˆë‹¤. ì‹¤ì œ êµ¬í˜„ì—ì„œëŠ” ë¡œê·¸ì¸ëœ ì‚¬ìš©ìì˜ IDë¥¼ ì‚¬ìš©í•´ì•¼ í•©ë‹ˆë‹¤.
            const response = await fetch('http://localhost:8000/chatbot/ask', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ user_query: userMessage, user_id: 1 }), // user_id í•„ë“œ ì¶”ê°€
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(`API ì˜¤ë¥˜: ${errorData.detail || response.statusText}`);
            }

            const data = await response.json(); // ì±—ë´‡ ì‘ë‹µ ë°ì´í„° (response, file_path í¬í•¨)
            let botResponseContent = data.response; // ê¸°ë³¸ ì‘ë‹µ í…ìŠ¤íŠ¸ (ì´ì œ HTMLì´ í¬í•¨ë  ìˆ˜ ìˆìŒ)

            // íŒŒì¼ ë‹¤ìš´ë¡œë“œ ë§í¬ ì²˜ë¦¬ (FastAPIì—ì„œ HTMLë¡œ ë³€í™˜í•˜ì§€ ì•Šìœ¼ë¯€ë¡œ ì—¬ê¸°ì„œ ì¶”ê°€)
            let additionalElementsHtml = '';
            if (data.file_path) {
                const fileName = data.file_path.split('/').pop(); // íŒŒì¼ëª…ë§Œ ì¶”ì¶œ
                const downloadUrl = `http://localhost:8000/files/${data.file_path}`; // FastAPIì˜ íŒŒì¼ ë‹¤ìš´ë¡œë“œ API ì—”ë“œí¬ì¸íŠ¸
                additionalElementsHtml += `<br><a href="${downloadUrl}" download="${fileName}" class="download-link">${fileName} ë‹¤ìš´ë¡œë“œ</a>`;
            }

            loadingMessageDiv.remove(); // ë¡œë”© ë©”ì‹œì§€ ì œê±°
            // ì±—ë´‡ ì‘ë‹µê³¼ ì¶”ê°€ HTML ìš”ì†Œë“¤ì„ í•¨ê»˜ í‘œì‹œ (botResponseContentëŠ” ì´ë¯¸ HTMLì¼ ìˆ˜ ìˆìŒ)
            addMessageToChat('bot', botResponseContent + additionalElementsHtml);


        } catch (error) {
            console.error("ì±—ë´‡ API í˜¸ì¶œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
            loadingMessageDiv.remove(); // ë¡œë”© ë©”ì‹œì§€ ì œê±°
            addMessageToChat('bot', `ì£„ì†¡í•©ë‹ˆë‹¤. ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`);
        }
    }
</script>
</body>
</html>